# データモデリングからみるRDB設計

## はじめに

あけましておめでとうございます。テクノロジーグループ所属、鈴木陸斗です。

SCCでは、半年間の努力と成果を定量的に量るために、目標管理シートを作成します。私は、その実施内容の一環として、あるテーマに沿って学習を行い、その成果をまとめてよろずやブログに掲載するという目標を定めました。

今回は、データモデリングの観点を中心に、RDB設計について学習したことをまとめていこうと思います。

### 目次

1. データモデリングの目的
2. ３つのデータモデリング
3. データモデリングの考え方・手法
    1. 5W1Hを意識する
    2. エンティティを分類する
    3. イベントに注目する
    4. イミュータブルデータモデル

## RDB設計のベストプラクティスとは？

はじめに、RDB設計のベストプラクティスを見ておきましょう。RDB設計には、さまざまな観点で考慮が必要です。どんなにデータモデリングが素晴らしいものでも、他の観点で考慮漏れがあっては、それは良いDB設計ではなくなってしまいます。

**RDB設計のベストプラクティス**

1. **DBの目的・目標を定める**
    
    DB設計だけではありませんが、開発において、利用される目的や目標を考えておくことは最も重要です。目的を理解することで、すべての考慮事項の判断基準となります。
    
2. **データモデリングに時間をかける**
    
    詳しいことは「データモデリング」で書きます。
    
3. **適切な正規化を行う**
    
    正規化はデータの冗長性を抑え、データの一貫性を保ちます。ただし、過度な正規化はパフォーマンスに悪い影響を及ぼすため、DBの目的を考えて判断するのがよさそうです。
    
4. **機密情報の保護を考慮する**
    
    データベースに格納する機密情報は保護する必要があります。機密情報が外部に漏えいした場合、信用問題にもかかわってきます。具体的な対策としては、データの暗号化や認証が考えられます。
    
5. **表・列・インデックス・キーなどの命名規則を標準化する**
    
    表名や列名の決定に迷った覚えはありませんか？命名規則を標準化することで、設計効率の向上したり、DBを長期的に正しく維持したりすることに役立ちます。命名規則に明確な正解はありませんが、少なくとも次のようなアンチパターンを避けるべきです。
    
    - 予約語（DBが利用するキーワード）を利用しない
    - スペースや特殊文字を使用しない
    - 略語を使わない
    
    **重要なのは、標準化した命名規則を守り続けることです。**
    
6. **設計を文書化する**
    
    文書を書くのは面倒なことですが、長期的なことを考えると必要なものです。私も文章を書くのは苦手ですが、がんばりましょう！
    

## データモデリングの目的

システムがデータベースを利用する目的は、企業のビジネス活動で発生したデータを記録・活用することです。

図　商品の販売

ビジネス活動で発生したデータを記録・活用するという目的を踏まえると、データを格納することができれば、その形態は何でもよいように思えます。しかし、そうすると次のような問題が発生します。

- 同じデータを何個も格納してしまい、ストレージを圧迫する
- 検索の効率が悪い
- 拡張性・保守性に欠ける

データモデリングは上記の問題を解消します。

データモデリングではモデルを図式化して表現します。一般的に、モデリングにはER図が利用されます。

したがって、データモデリングの目的は企業の**ビジネス活動を映し出したER図**を完成させることといえます。

※ER図の書き方や見方は調べればたくさん出てくるので、割愛させていただきます。

## ３つのデータモデリング

データモデリングは、概念データモデリング・論理データモデリング・物理データモデリングの３つに分けられます。それぞれのデータモデリングは、システム開発工程と対応して行われます。

### 概念データモデリング

概念データモデリングでは、次のことを行います。

- システム化の対象範囲にあるデータを洗い出し
- 格納するデータを決定する
- データがどのように関連しあっているかを整理する（従属関係の整理）

ここで重要なことは、ビジネスの視点で設計を行うことです。テーブル・インデックスなどシステム的な観点の仕様決定は、物理データモデリングの工程で行います。

### 論理データモデリング

論理データモデリングでは、概念データモデリングで作成した概念データモデルをベースに、「正規化」を行います。

論理データモデリングも概念データモデリングと同様に、ビジネスの視点でデータを整理すること重要です。

### 物理データモデリング

物理データモデリングでは、論理データモデリングで作成した論理データモデルをベースに、システムとして動作するように調整を行います。

物理データモデリングでは論理データモデリングとは対照的に、システムの視点でモデリングを行います。

## データモデリングの手法・考え方

考え方として他にもたくさんの技がありますが、簡単で今すぐ意識できるものを紹介します。興味を持っていいただけたら、もっと深堀してみてください。

### イミュータブルデータモデル

イミュータブルデータモデルは、システムでもっとも複雑になる更新処理を、できるだけ排除することを方針としたデータモデリングの手法です。

イミュータブル（immutable：変更不可能な）

例えば、次のような要件があったとします。

- 会員はECサイトの商品を購入する。
- 購入のあと入金を確認する必要がある。
- 購入はキャンセルすることもできる。
- 購入日時・入金日時・キャンセル日時は参照できる必要がある。

これを簡単にER図で表してみます。

図

購入エンティティには、たくさんの日時属性がふくまれており、一度データが登録されたあとも、複数回更新されることが予想されます。

**イベントには一つだけ日時を持たせる**

イベントには１つだけ日時を持たせるようにします。こうすることで、イベントエンティティは、追加処理だけ行えばよく、複雑な更新処理を排除することができました。

### 5W1Hを意識する

エンティティと、エンティティに格納される属性を洗い出すときは、**5W1H**を意識しましょう。

- who：社員、顧客
- what：商品
- when：年、月、日付、日時
- where：営業所、拠点、宛先、URL
- why：受注、出荷
- how：請求書、注文書

### エンティティを分類する

エンティティは、**リソース**と**イベント**に分けられます。エンティティを分類することで、後述するイミュータブルデータモデルの作成を行うことができます。

リソースとイベントの特徴を整理すると次のことが言えます。

|  | リソース | イベント |
| --- | --- | --- |
| 日時属性 | なし | あり |
| 属性の変更 | あり | なし |
| 対応する5W1H | who, what, when, where | why, how |

基本的に、リソースはすべて永続化の対象となります。一方、イベントは永続化しなくてもよいものも存在します。データを記録・管理するにもお金がかかるので、必要に応じて取捨選択したいところです。

永続化の要否の判断は次のことを意識しましょう。

- そのイベントが利益を生むものであるか
- そのイベントを記録しておかない場合、利益を損なうリスクがあるか

### エンティティ間のつながり

### イベントに注目する

データモデリングを行うとき、全体の関係を把握することは頭を悩ませる問題の一つです。このような場合、**イベントに注目する**と整理がしやすくなります。

例えば、購入イベントや出荷イベントに注目して関連を整理してみます。

- 購入（イベント）があったとすると、購入者（リソース）や商品（リソース）と結びつく　イベントからリソースを関係を整理する
- 購入イベントのあと、出荷イベントが発生する。　イベントが発生する時間軸で、前後関係を整理する
    
    →これは図として表現する。
    

もし、リソースから関係を整理すると、考えが発散してしまい、設計ミスにつながります。

データの源泉は、ビジネス活動（イベント）ということを常に意識したいですね。

- データは企業のビジネス活動によって人/モノ/金の動きに連動したデータが発生する。
- ビジネスとデータの関係を図式化したものが、いわゆるER図と呼ばれるものです。データモデリングとは、ビジネスの流れをER図に落とし込むことといえます。
- ER図に存在するのはエンティティ（データのあつまり）とリレーションシップ（エンティティの関係）
- エンティティはその性質として、マスタ（リソース）とトランザクション（イベント）に分けることができる。データモデリングでビジネスをとらえる場合は、トランザクションに着目して補足するとよい。そのあと、ビジネスの流れをとらえることができたら、マスタを深堀して考えていこう。イベントによって、リソースが生成・更新・削除される。リソースは基本的に永続化の対象となる（会員とか）。
- イベントを永続化するかはビジネス活動の目的から考察する必要がある。（例えば、会員にポイントを付与するアプリケーションがあったとして、ある会員に対するポイント付与イベントを永続化するか？）

## 参考文献

[https://ja.wikipedia.org/wiki/データベース設計](https://ja.wikipedia.org/wiki/%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E8%A8%AD%E8%A8%88)

[https://thinkit.co.jp/story/2010/10/07/1788?nopaging=1](https://thinkit.co.jp/story/2010/10/07/1788?nopaging=1)

[https://zenn.dev/cacbahbj/articles/9a17170967fb50](https://zenn.dev/cacbahbj/articles/9a17170967fb50)
